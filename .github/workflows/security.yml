name: Security Scans

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Ejecutar cada lunes a las 2 AM

# âœ… PERMISOS GLOBALES NECESARIOS
permissions:
  contents: read
  security-events: write
  actions: read
  checks: write

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    # âœ… PERMISOS ESPECÃFICOS PARA ESTE JOB
    permissions:
      actions: read
      contents: read
      security-events: write
      checks: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        config-file: ./.github/codeql/codeql-config.yml
        source-root: .
        debug: false

    - name: Autobuild
      uses: github/codeql-action/autobuild@v3

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"
        upload: true
        wait-for-processing: true

  dependency-check:
    runs-on: ubuntu-latest
    
    # âœ… PERMISOS PARA DEPENDENCY CHECK
    permissions:
      contents: read
      security-events: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          frontend-plataforma/node_modules
          backend/*/node_modules
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Install frontend dependencies
      working-directory: ./frontend-plataforma
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: Run dependency check for frontend
      working-directory: ./frontend-plataforma
      run: |
        echo "ðŸ” Checking frontend dependencies..."
        npm audit --audit-level moderate || echo "âš ï¸ Frontend audit completed with warnings"

    - name: Install backend dependencies and audit
      run: |
        echo "ðŸ” Checking backend dependencies..."
        services=("usuarios" "prestamos" "pagos")
        
        for service in "${services[@]}"; do
          if [ -d "backend/$service" ] && [ -f "backend/$service/package.json" ]; then
            echo "ðŸ” Installing and auditing $service service..."
            cd "backend/$service"
            
            # Instalar dependencias
            if [ -f package-lock.json ]; then
              npm ci || npm install
            else
              npm install
            fi
            
            # Ejecutar audit
            npm audit --audit-level moderate || echo "âš ï¸ $service audit completed with warnings"
            cd - > /dev/null
          else
            echo "âš ï¸ Skipping $service - directory or package.json not found"
          fi
        done

    - name: Check for known vulnerabilities
      run: |
        echo "ðŸ” Checking for known vulnerabilities..."
        
        # Verificar versiones de Node.js y npm
        echo "ðŸ“¦ Node.js version: $(node --version)"
        echo "ðŸ“¦ npm version: $(npm --version)"
        
        # Buscar dependencias desactualizadas
        echo "ðŸ” Checking for outdated packages..."
        npm outdated || echo "âœ… All packages are up to date"

  secret-scan:
    runs-on: ubuntu-latest
    
    # âœ… PERMISOS PARA SECRET SCANNING
    permissions:
      contents: read
      security-events: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run secret scanning
      run: |
        echo "ðŸ” Scanning for potential secrets..."
        
        # Crear directorio para resultados
        mkdir -p security-results
        
        # Buscar patrones de secrets en el cÃ³digo
        echo "ðŸ“ Checking for hardcoded secrets..."
        
        # Buscar passwords
        echo "ðŸ” Checking for hardcoded passwords..."
        if grep -r -n -i "password\s*[=:]\s*['\"][^'\"]*['\"]" --include="*.js" --include="*.ts" --include="*.tsx" --include="*.json" . | grep -v node_modules | grep -v test | grep -v ".git" | grep -v coverage | head -10; then
          echo "âš ï¸ Potential hardcoded passwords found" | tee security-results/passwords.txt
        else
          echo "âœ… No hardcoded passwords detected"
        fi
        
        # Buscar API keys
        echo "ðŸ” Checking for API keys..."
        if grep -r -n -i -E "(api_key|apikey|api-key)\s*[=:]\s*['\"][^'\"]*['\"]" --include="*.js" --include="*.ts" --include="*.tsx" --include="*.json" . | grep -v node_modules | grep -v test | grep -v ".git" | grep -v coverage | head -10; then
          echo "âš ï¸ Potential API keys found" | tee security-results/api-keys.txt
        else
          echo "âœ… No hardcoded API keys detected"
        fi
        
        # Buscar tokens JWT o de acceso
        echo "ðŸ” Checking for access tokens..."
        if grep -r -n -i -E "(token|jwt|bearer)\s*[=:]\s*['\"][^'\"]{20,}['\"]" --include="*.js" --include="*.ts" --include="*.tsx" --include="*.json" . | grep -v node_modules | grep -v test | grep -v ".git" | grep -v coverage | head -10; then
          echo "âš ï¸ Potential tokens found" | tee security-results/tokens.txt
        else
          echo "âœ… No hardcoded tokens detected"
        fi
        
        # Buscar URLs de bases de datos
        echo "ðŸ” Checking for database URLs..."
        if grep -r -n -i -E "(DATABASE_URL|DB_URL|POSTGRES_URL)\s*[=:]\s*['\"][^'\"]*['\"]" --include="*.js" --include="*.ts" --include="*.tsx" --include="*.json" . | grep -v node_modules | grep -v test | grep -v ".git" | grep -v coverage | head -10; then
          echo "âš ï¸ Potential database URLs found" | tee security-results/db-urls.txt
        else
          echo "âœ… No hardcoded database URLs detected"
        fi
        
        echo "âœ… Secret scan completed"

    - name: Check environment variables usage
      run: |
        echo "ðŸ” Checking environment variables usage..."
        
        # Verificar que se usen variables de entorno en lugar de hardcoding
        ENV_USAGE=$(grep -r "process.env" --include="*.js" --include="*.ts" . | grep -v node_modules | wc -l)
        if [ "$ENV_USAGE" -gt 0 ]; then
          echo "âœ… Environment variables are being used properly ($ENV_USAGE occurrences)"
          echo "ðŸ“‹ Most common environment variables:"
          grep -r -o "process\.env\.[A-Z_][A-Z0-9_]*" --include="*.js" --include="*.ts" . | grep -v node_modules | sort | uniq -c | sort -nr | head -10
        else
          echo "âš ï¸ Consider using more environment variables for configuration"
        fi

    - name: Scan for security anti-patterns
      run: |
        echo "ðŸ” Scanning for security anti-patterns..."
        
        # Buscar eval() usage
        if grep -r -n "eval(" --include="*.js" --include="*.ts" . | grep -v node_modules | grep -v test; then
          echo "âš ï¸ eval() usage found - potential security risk"
        else
          echo "âœ… No eval() usage detected"
        fi
        
        # Buscar innerHTML assignments
        if grep -r -n "innerHTML\s*=" --include="*.js" --include="*.ts" --include="*.tsx" . | grep -v node_modules | grep -v test; then
          echo "âš ï¸ innerHTML assignments found - potential XSS risk"
        else
          echo "âœ… No risky innerHTML assignments detected"
        fi
        
        # Buscar SQL concatenation
        if grep -r -n -i "select.*+.*from\|insert.*+.*into\|update.*+.*set\|delete.*+.*from" --include="*.js" --include="*.ts" . | grep -v node_modules | grep -v test; then
          echo "âš ï¸ Potential SQL injection vulnerability found"
        else
          echo "âœ… No obvious SQL injection patterns detected"
        fi

    - name: Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-results
        path: security-results/
        retention-days: 30

  license-check:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install license checker
      run: npm install -g license-checker

    - name: Check licenses
      run: |
        echo "ðŸ“‹ Checking licenses for compliance..."
        
        # Frontend licenses
        if [ -d "frontend-plataforma" ] && [ -f "frontend-plataforma/package.json" ]; then
          echo "ðŸ” Frontend licenses:"
          cd frontend-plataforma
          if [ -f package-lock.json ]; then
            npm ci || npm install
          else
            npm install
          fi
          license-checker --summary || echo "âš ï¸ License check completed with warnings"
          cd ..
        fi
        
        # Backend licenses
        services=("usuarios" "prestamos" "pagos")
        for service in "${services[@]}"; do
          if [ -d "backend/$service" ] && [ -f "backend/$service/package.json" ]; then
            echo "ðŸ” $service service licenses:"
            cd "backend/$service"
            if [ -f package-lock.json ]; then
              npm ci || npm install
            else
              npm install
            fi
            license-checker --summary || echo "âš ï¸ License check completed with warnings"
            cd - > /dev/null
          fi
        done

  notify-security-completion:
    needs: [codeql, dependency-check, secret-scan, license-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Security scan summary
      run: |
        echo "ðŸ›¡ï¸ Security Scan Summary"
        echo "======================="
        echo "CodeQL Analysis: ${{ needs.codeql.result }}"
        echo "Dependency Check: ${{ needs.dependency-check.result }}"
        echo "Secret Scanning: ${{ needs.secret-scan.result }}"
        echo "License Check: ${{ needs.license-check.result }}"
        echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${GITHUB_REF#refs/heads/}"
        echo "Commit: ${{ github.sha }}"
        echo "Run ID: ${{ github.run_id }}"
        
        # Calcular estado general
        FAILED_SCANS=""
        
        if [[ "${{ needs.codeql.result }}" != "success" ]]; then
          FAILED_SCANS="$FAILED_SCANS CodeQL"
        fi
        
        if [[ "${{ needs.dependency-check.result }}" != "success" ]]; then
          FAILED_SCANS="$FAILED_SCANS Dependencies"
        fi
        
        if [[ "${{ needs.secret-scan.result }}" != "success" ]]; then
          FAILED_SCANS="$FAILED_SCANS Secrets"
        fi
        
        if [[ "${{ needs.license-check.result }}" != "success" ]]; then
          FAILED_SCANS="$FAILED_SCANS Licenses"
        fi
        
        if [[ -z "$FAILED_SCANS" ]]; then
          echo "âœ… All security scans passed successfully!"
          echo "ðŸŽ‰ Security posture is good"
        else
          echo "âš ï¸ Some security scans had issues: $FAILED_SCANS"
          echo "ðŸ“‹ Please review the logs for details"
        fi
        
        # Generar reporte de seguridad
        echo "ðŸ“Š Security Report" > security-report.md
        echo "=================" >> security-report.md
        echo "" >> security-report.md
        echo "**Repository:** ${{ github.repository }}" >> security-report.md
        echo "**Branch:** ${GITHUB_REF#refs/heads/}" >> security-report.md
        echo "**Commit:** ${{ github.sha }}" >> security-report.md
        echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
        echo "" >> security-report.md
        echo "## Results" >> security-report.md
        echo "- **CodeQL Analysis:** ${{ needs.codeql.result }}" >> security-report.md
        echo "- **Dependency Check:** ${{ needs.dependency-check.result }}" >> security-report.md
        echo "- **Secret Scanning:** ${{ needs.secret-scan.result }}" >> security-report.md
        echo "- **License Check:** ${{ needs.license-check.result }}" >> security-report.md

    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 90